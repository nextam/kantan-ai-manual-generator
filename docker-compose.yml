services:
  manual:
    build:
      context: ./manual_generator
      target: production # Multi-stage buildのproduction stage
      cache_from:
        - manual-generator:latest
    image: manual-generator:latest
    container_name: manual-generator
    ports:
      - "8080:5000"
    environment:
      PYTHONUNBUFFERED: "1"
      PORT: "5000"
      LOG_DIR: /app/logs
      GOOGLE_APPLICATION_CREDENTIALS: /app/gcp-credentials.json
      DATABASE_PATH: /app/instance/manual_generator.db
      # 既定値（アプリ側でもデフォルトが設定されています）
      GCS_BUCKET_NAME: manual_generator
      PROJECT_ID: career-survival
    env_file:
      - ./manual_generator/.env
    volumes:
      - manual_logs:/app/logs
      - manual_instance:/app/instance
      - manual_uploads:/app/uploads
    command: >
      bash -c "
      chmod +x /app/startup.sh &&
      /app/startup.sh
      "

volumes:
  manual_logs: {}
  manual_instance: {}
  manual_uploads: {}
