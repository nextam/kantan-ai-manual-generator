{% extends "base.html" %}

{% block title %}{% if template_id %}テンプレート編集{% else %}テンプレート新規作成{% endif %}{% endblock %}

{% block page_title %}{% if template_id %}テンプレート編集{% else %}テンプレート新規作成{% endif %}{% endblock %}

{% block extra_styles %}
<style>
    .editor-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .editor-header {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 20px;
    }
    
    .editor-header-content {
        flex: 1;
    }
    
    .btn-back {
        padding: 10px 16px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        transition: background 0.2s;
    }
    
    .btn-back:hover {
        background: #5a6268;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
    }
    
    .form-control {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #2196F3;
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }
    
    .sections-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .section-item {
        background: #f9f9f9;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 10px;
        border-left: 3px solid #2196F3;
    }
    
    .section-header {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 10px;
        align-items: start;
    }
    
    .section-content {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1;
    }
    
    .section-fields-row {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 10px;
    }
    
    .section-field {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .section-field label {
        font-size: 11px;
        color: #666;
        font-weight: 500;
        margin: 0;
    }
    
    .section-field input {
        padding: 5px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
    }
    
    .section-prompt {
        margin-top: 0;
    }
    
    .section-prompt textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
        resize: vertical;
        min-height: 60px;
    }
    
    .section-prompt-toggle {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #2196F3;
        cursor: pointer;
        margin-bottom: 8px;
        user-select: none;
    }
    
    .section-prompt-toggle input[type="checkbox"] {
        cursor: pointer;
    }
    
    .section-actions {
        display: flex;
        flex-direction: row;
        gap: 4px;
    }
    
    .section-move-buttons {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .btn-icon {
        padding: 4px 6px;
        min-width: auto;
        font-size: 11px;
        line-height: 1;
    }
    
    .btn-icon .material-icons {
        font-size: 14px;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-primary {
        background: #2196F3;
        color: white;
    }
    
    .btn-success {
        background: #4CAF50;
        color: white;
    }
    
    .btn-danger {
        background: #f44336;
        color: white;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn:hover {
        opacity: 0.9;
    }
    
    .btn-sm {
        padding: 4px 8px;
        font-size: 12px;
    }
    
    .btn-sm .material-icons {
        font-size: 14px;
    }
    
    .actions-bar {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e0e0e0;
    }
</style>
{% endblock %}

{% block content %}
<div class="editor-container">
    <div class="editor-header">
        <a href="/company/templates" class="btn-back">
            <span class="material-icons" style="font-size: 18px;">arrow_back</span>
            一覧へ戻る
        </a>
        <div class="editor-header-content">
            <h1 style="margin: 0 0 10px 0;">{% if template_id %}テンプレート編集{% else %}テンプレート新規作成{% endif %}</h1>
            <p style="color: #666; margin: 0;">テンプレートの基本情報とセクション構成を{% if template_id %}編集{% else %}設定{% endif %}できます</p>
        </div>
    </div>
    
    <div class="form-group">
        <label for="templateName">テンプレート名</label>
        <input type="text" id="templateName" class="form-control" placeholder="テンプレート名を入力">
    </div>
    
    <div class="form-group">
        <label for="templateDescription">説明</label>
        <textarea id="templateDescription" class="form-control" rows="3" placeholder="テンプレートの説明を入力"></textarea>
    </div>
    
    <div class="sections-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">セクション構成</h3>
            <button class="btn btn-success" onclick="addSection()">
                <span class="material-icons" style="font-size: 18px;">add</span>
                セクション追加
            </button>
        </div>
        
        <div id="sectionsContainer">
            <!-- Sections will be loaded here -->
        </div>
    </div>
    
    <div class="actions-bar">
        <button class="btn btn-secondary" onclick="window.location.href='/company/templates'">
            <span class="material-icons" style="font-size: 18px;">arrow_back</span>
            戻る
        </button>
        <button class="btn btn-primary" onclick="saveTemplate()">
            <span class="material-icons" style="font-size: 18px;">save</span>
            保存
        </button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const templateId = {{ template_id if template_id else 'null' }};
    let sections = [];
    
    // Load template data
    async function loadTemplate() {
        if (!templateId) {
            // New template - initialize with default sections
            sections = [
                { id: 'section_0', title: 'はじめに', custom_prompt: '' },
                { id: 'section_1', title: '主な内容', custom_prompt: '' },
                { id: 'section_2', title: 'まとめ', custom_prompt: '' }
            ];
            renderSections();
            return;
        }
        
        try {
            const response = await fetch(`/api/company/templates/${templateId}`);
            if (!response.ok) throw new Error('Failed to load template');
            
            const template = await response.json();
            
            document.getElementById('templateName').value = template.name;
            document.getElementById('templateDescription').value = template.description || '';
            
            // Load sections
            const templateContent = template.template_content || {};
            sections = (templateContent.sections || []).map(section => ({
                ...section,
                custom_prompt: section.custom_prompt || ''
            }));
            renderSections();
        } catch (error) {
            console.error('Error loading template:', error);
            alert('テンプレートの読み込みに失敗しました');
        }
    }
    
    function renderSections() {
        const container = document.getElementById('sectionsContainer');
        
        if (sections.length === 0) {
            container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">セクションがありません。「セクション追加」ボタンでセクションを追加してください。</p>';
            return;
        }
        
        container.innerHTML = sections.map((section, index) => {
            const hasPrompt = section.custom_prompt && section.custom_prompt.trim().length > 0;
            return `
            <div class="section-item" data-index="${index}">
                <div class="section-header">
                    <div class="section-move-buttons">
                        <button class="btn btn-sm btn-secondary btn-icon" onclick="moveSectionUp(${index})" 
                                ${index === 0 ? 'disabled' : ''} title="上へ">
                            <span class="material-icons">↑</span>
                        </button>
                        <button class="btn btn-sm btn-secondary btn-icon" onclick="moveSectionDown(${index})" 
                                ${index === sections.length - 1 ? 'disabled' : ''} title="下へ">
                            <span class="material-icons">↓</span>
                        </button>
                    </div>
                    
                    <div class="section-content">
                        <div class="section-fields-row">
                            <div class="section-field">
                                <label>セクションID</label>
                                <input type="text" value="${section.id}" 
                                       oninput="updateSection(${index}, 'id', this.value)"
                                       placeholder="section_${index}">
                            </div>
                            
                            <div class="section-field">
                                <label>セクション名</label>
                                <input type="text" value="${section.title}" 
                                       oninput="updateSection(${index}, 'title', this.value)"
                                       placeholder="セクション名">
                            </div>
                        </div>
                        
                        <div class="section-prompt">
                            <label class="section-prompt-toggle">
                                <input type="checkbox" 
                                       ${hasPrompt ? 'checked' : ''}
                                       onchange="togglePrompt(${index}, this.checked)">
                                カスタムプロンプトを使用
                            </label>
                            <div id="promptField_${index}" style="display: ${hasPrompt ? 'block' : 'none'};">
                                <textarea 
                                    placeholder="このセクションの生成に関する追加指示を入力（例：「安全注意事項を強調してください」「初心者向けに詳しく説明してください」）"
                                    oninput="updateSection(${index}, 'custom_prompt', this.value)">${section.custom_prompt || ''}</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-actions">
                        <button class="btn btn-danger btn-icon" onclick="removeSection(${index})" title="削除">
                            <span class="material-icons">delete</span>
                        </button>
                    </div>
                </div>
            </div>
        `}).join('');
    }
    
    function togglePrompt(index, enabled) {
        const field = document.getElementById(`promptField_${index}`);
        field.style.display = enabled ? 'block' : 'none';
        if (!enabled) {
            sections[index].custom_prompt = '';
        }
    }
    
    function addSection() {
        const newIndex = sections.length;
        sections.push({
            id: `section_${newIndex}`,
            title: `新しいセクション ${newIndex + 1}`,
            custom_prompt: ''
        });
        renderSections();
    }
    
    function updateSection(index, field, value) {
        sections[index][field] = value;
    }
    
    function removeSection(index) {
        if (!confirm('このセクションを削除しますか？')) return;
        sections.splice(index, 1);
        renderSections();
    }
    
    function moveSectionUp(index) {
        if (index === 0) return;
        [sections[index - 1], sections[index]] = [sections[index], sections[index - 1]];
        renderSections();
    }
    
    function moveSectionDown(index) {
        if (index === sections.length - 1) return;
        [sections[index], sections[index + 1]] = [sections[index + 1], sections[index]];
        renderSections();
    }
    
    async function saveTemplate() {
        const name = document.getElementById('templateName').value.trim();
        const description = document.getElementById('templateDescription').value.trim();
        
        if (!name) {
            alert('テンプレート名を入力してください');
            return;
        }
        
        if (sections.length === 0) {
            alert('少なくとも1つのセクションを追加してください');
            return;
        }
        
        // Ensure all textarea values are captured before saving
        // Read from DOM directly to capture all values
        const sectionsContainer = document.getElementById('sectionsContainer');
        const sectionItems = sectionsContainer.querySelectorAll('.section-item');
        
        sectionItems.forEach((item, index) => {
            if (index < sections.length) {
                // Get title and id from inputs
                const idInput = item.querySelector('input[placeholder^="section_"]');
                const titleInput = item.querySelector('input[placeholder="セクション名"]');
                const textarea = item.querySelector('textarea');
                const checkbox = item.querySelector('.section-prompt-toggle input[type="checkbox"]');
                
                if (idInput) sections[index].id = idInput.value;
                if (titleInput) sections[index].title = titleInput.value;
                
                // Only save custom_prompt if checkbox is checked AND textarea has value
                if (checkbox && checkbox.checked && textarea) {
                    sections[index].custom_prompt = textarea.value;
                    console.log(`Section ${index} (${sections[index].title}): prompt length = ${textarea.value.length}, value = "${textarea.value.substring(0, 50)}..."`);
                } else {
                    sections[index].custom_prompt = '';
                    console.log(`Section ${index} (${sections[index].title}): checkbox not checked or textarea not found`);
                }
            }
        });
        
        console.log('=== Final sections array ===');
        console.log(JSON.stringify(sections, null, 2));
        
        const requestBody = {
            name,
            description,
            template_content: { sections }
        };
        
        console.log('=== Request body ===');
        console.log(JSON.stringify(requestBody, null, 2));
        
        try {
            const isNewTemplate = !templateId;
            const url = isNewTemplate ? '/api/company/templates' : `/api/company/templates/${templateId}`;
            const method = isNewTemplate ? 'POST' : 'PUT';
            
            console.log(`Sending ${method} request to ${url}`);
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to save template');
            }
            
            const successMessage = isNewTemplate ? 'テンプレートを作成しました' : 'テンプレートを保存しました';
            alert(successMessage);
            window.location.href = '/company/templates';
        } catch (error) {
            console.error('Error saving template:', error);
            alert(`保存に失敗しました: ${error.message}`);
        }
    }
    
    // Initialize
    loadTemplate();
</script>
{% endblock %}
