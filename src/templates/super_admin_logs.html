{% extends "base.html" %}

{% block title %}Activity Logs - Super Admin{% endblock %}

{% block page_title %}Activity Logs{% endblock %}

{% block extra_styles %}
<style>
    .logs-container {
        padding: 20px;
    }
    
    .filters-bar {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
    
    .filter-group label {
        display: block;
        font-size: 13px;
        color: #666;
        margin-bottom: 5px;
    }
    
    .filter-group select,
    .filter-group input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .btn-filter {
        padding: 8px 20px;
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        align-self: flex-end;
    }
    
    .btn-export {
        padding: 8px 20px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        align-self: flex-end;
    }
    
    .logs-table {
        width: 100%;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .logs-table table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .logs-table th {
        background: #f5f5f5;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #e0e0e0;
        position: sticky;
        top: 0;
    }
    
    .logs-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 13px;
    }
    
    .logs-table tr:hover {
        background: #fafafa;
    }
    
    .action-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
    }
    
    .action-create {
        background: #e8f5e9;
        color: #2e7d32;
    }
    
    .action-update {
        background: #e3f2fd;
        color: #1565c0;
    }
    
    .action-delete {
        background: #ffebee;
        color: #c62828;
    }
    
    .action-login {
        background: #f3e5f5;
        color: #7b1fa2;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        gap: 10px;
    }
    
    .pagination button {
        padding: 8px 16px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .pagination span {
        color: #666;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div class="logs-container">
    <div class="filters-bar">
        <div class="filter-group">
            <label>Action Type</label>
            <select id="filterAction">
                <option value="">All Actions</option>
                <option value="create">Create</option>
                <option value="update">Update</option>
                <option value="delete">Delete</option>
                <option value="login">Login</option>
            </select>
        </div>
        <div class="filter-group">
            <label>User</label>
            <input type="text" id="filterUser" placeholder="Username or email">
        </div>
        <div class="filter-group">
            <label>Date From</label>
            <input type="date" id="filterDateFrom">
        </div>
        <div class="filter-group">
            <label>Date To</label>
            <input type="date" id="filterDateTo">
        </div>
        <button class="btn-filter" onclick="applyFilters()">Apply Filters</button>
        <button class="btn-export" onclick="exportLogs()">
            <span class="material-icons" style="vertical-align: middle; font-size: 16px;">download</span>
            Export
        </button>
    </div>
    
    <div class="logs-table">
        <div id="loadingIndicator" class="loading">
            Loading activity logs...
        </div>
        <div id="logsContent" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Resource</th>
                        <th>Details</th>
                        <th>IP Address</th>
                    </tr>
                </thead>
                <tbody id="logsTableBody">
                </tbody>
            </table>
            <div class="pagination">
                <button id="btnPrevPage" onclick="loadPage(currentPage - 1)">Previous</button>
                <span id="pageInfo">Page 1</span>
                <button id="btnNextPage" onclick="loadPage(currentPage + 1)">Next</button>
            </div>
        </div>
        <div id="emptyState" class="empty-state" style="display: none;">
            <span class="material-icons" style="font-size: 64px; color: #ccc;">history</span>
            <p>No activity logs found</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentPage = 1;
    let totalPages = 1;
    
    async function loadLogs(page = 1) {
        try {
            const params = new URLSearchParams({
                page: page,
                per_page: 50
            });
            
            const response = await fetch(`/api/super-admin/activity-logs?${params}`);
            if (!response.ok) throw new Error('Failed to load logs');
            
            const data = await response.json();
            const logs = data.logs || [];
            
            currentPage = page;
            totalPages = data.total_pages || 1;
            
            document.getElementById('loadingIndicator').style.display = 'none';
            
            if (logs.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            
            const tbody = document.getElementById('logsTableBody');
            tbody.innerHTML = logs.map(log => {
                const actionClass = `action-${(log.action_type || log.action || '').toLowerCase()}`;
                return `
                    <tr>
                        <td>${new Date(log.created_at || log.timestamp).toLocaleString()}</td>
                        <td>${log.user_id || '-'}</td>
                        <td>
                            <span class="action-badge ${actionClass}">
                                ${log.action_type || log.action || '-'}
                            </span>
                        </td>
                        <td>${log.company_id || '-'}</td>
                        <td>${log.description || log.details || '-'}</td>
                        <td>-</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('btnPrevPage').disabled = currentPage <= 1;
            document.getElementById('btnNextPage').disabled = currentPage >= totalPages;
            
            document.getElementById('logsContent').style.display = 'block';
        } catch (error) {
            console.error('Error loading logs:', error);
            document.getElementById('loadingIndicator').innerHTML = '<p style="color: red;">Error loading activity logs</p>';
        }
    }
    
    function loadPage(page) {
        loadLogs(page);
    }
    
    function applyFilters() {
        alert('Filter functionality - to be implemented');
    }
    
    async function exportLogs() {
        try {
            const response = await fetch('/api/super-admin/activity-logs/export');
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `activity_logs_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } catch (error) {
            console.error('Error exporting logs:', error);
            alert('Error exporting logs');
        }
    }
    
    loadLogs();
</script>
{% endblock %}
