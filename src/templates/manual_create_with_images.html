{% extends "base.html" %}

{% block title %}ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æ–°è¦ä½œæˆï¼ˆç”»åƒã‚ã‚Šï¼‰{% endblock %}
{% block page_title %}ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ï¼ˆç”»åƒã‚ã‚Šï¼‰ç”Ÿæˆ{% endblock %}

{% block extra_styles %}
    <style>
        .breadcrumb {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            color: #666;
            border: 1px solid #e9ecef;
        }

        .breadcrumb a {
            color: #007bff;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            color: #0056b3;
        }

        .form-section {
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }

        .form-section h3 {
            color: #333;
            margin-top: 0;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #f8f9fa;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #0056b3;
            background-color: #e3f2fd;
        }

        .upload-area.dragover {
            border-color: #0056b3;
            background-color: #e3f2fd;
        }

        .upload-area.has-file {
            border-color: #1976d2;
            background-color: #e3f2fd;
        }

        .video-preview {
            display: none;
            margin-top: 15px;
        }

        .video-preview video {
            width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .video-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #007bff;
            border: 1px solid #e9ecef;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }

        .btn:disabled {
            background: #6c757d !important;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn .material-icons {
            font-size: 16px;
        }

        /* é€²è¡ŒçŠ¶æ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .progress-section {
            display: none;
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .progress-section h3 {
            color: #1976d2;
            margin: 0 0 15px 0;
        }

        .progress-section p {
            color: #424242;
            margin: 5px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šçŸ¥ã‚¹ã‚¿ã‚¤ãƒ« */
        .message {
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
        }

        .message .material-icons {
            margin-right: 8px;
            font-size: 20px;
        }

        .success-message {
            background-color: #1976d2;
        }

        .error-message {
            background-color: #d32f2f;
        }

        .info-message {
            background-color: #007bff;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
        }
    </style>
{% endblock %}

{% block content %}
    <div style="max-width: 1200px;">
        <!-- ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ -->
        <div class="breadcrumb">
            <a href="/manual/list">ğŸ“‹ ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ä¸€è¦§</a> &gt; ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ï¼ˆç”»åƒã‚ã‚Šï¼‰ç”Ÿæˆ
        </div>

        <!-- é€²è¡ŒçŠ¶æ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="progress-section" id="progress-section">
            <div class="spinner"></div>
            <h3 id="progress-title">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç”Ÿæˆä¸­...</h3>
            <p id="progress-message">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ï¼ˆç”»åƒã‚ã‚Šï¼‰ç”Ÿæˆã®å‡¦ç†ã‚’é †æ¬¡å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>
        </div>

        <!-- ãƒ•ã‚©ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <form id="manual-form">
            <div class="form-section">
                <h3><span class="material-icons" style="vertical-align: middle; margin-right: 8px;">cloud_upload</span>å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                <div class="form-group">
                    <label for="video-file">ä½œæ¥­å‹•ç”»ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆMP4ã€MOVã€AVIå½¢å¼ï¼‰</label>
                    <div class="upload-area" id="upload-area">
                        <input type="file" id="video-file" accept="video/*" style="display: none;">
                        <div>
                            <h4><span class="material-icons" style="font-size: 24px; vertical-align: middle; margin-right: 8px;">smart_display</span>ä½œæ¥­å‹•ç”»ã‚’é¸æŠã—ã¦ãã ã•ã„</h4>
                            <p>æ­£ã—ã„æ‰‹é †ãƒ»ã‚³ãƒ„ã‚’å«ã‚€å‹•ç”»</p>
                            <button type="button" class="btn btn-primary" onclick="document.getElementById('video-file').click()">
                                <span class="material-icons">upload_file</span>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                            </button>
                            <p><small>MP4, AVI, MOVå¯¾å¿œï¼ˆæœ€å¤§2GBï¼‰</small></p>
                        </div>
                    </div>
                    <div class="video-preview" id="video-preview">
                        <video id="video" controls></video>
                        <div class="video-info" id="video-info"></div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3><span class="material-icons" style="vertical-align: middle; margin-right: 8px;">settings</span>ç”Ÿæˆè¨­å®š</h3>
                <div class="form-group">
                    <label for="manual-title">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="manual-title" placeholder="ä¾‹ï¼šã‚¨ã‚¯ã‚»ãƒ«ä½œæ¥­æ‰‹é †">
                </div>
                <div class="form-group">
                    <label for="manual-description">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«èª¬æ˜</label>
                    <textarea id="manual-description" rows="3" placeholder="ã“ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã®ç›®çš„ã€å¯¾è±¡è€…ã€æ¦‚è¦ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚"></textarea>
                </div>
                <!-- æ–‡ä½“ã®é¸æŠè‚¢ã¯ä¸è¦ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ä½“è¨€æ­¢ã‚ã®ç®‡æ¡æ›¸ãï¼‰ -->
                <div class="form-group">
                    <label for="length">å‡ºåŠ›è©³ç´°åº¦</label>
                    <select id="length">
                        <option value="">æŒ‡å®šã—ãªã„</option>
                        <option value="concise">ç°¡æ½”ï¼ˆå„é …ç›®1-2è¡Œï¼‰</option>
                        <option value="standard">æ¨™æº–ï¼ˆå„é …ç›®2-4è¡Œï¼‰</option>
                        <option value="detailed">è©³ç´°ï¼ˆå„é …ç›®4-6è¡Œï¼‰</option>
                    </select>
                    <small class="form-text text-muted">é¸æŠã™ã‚‹ã¨ã€ã‚«ã‚¹ã‚¿ãƒ æŒ‡ç¤ºã«å¯¾å¿œã™ã‚‹å†…å®¹ãŒè‡ªå‹•ã§è¿½åŠ ã•ã‚Œã¾ã™</small>
                </div>
                <div class="form-group">
                    <label for="custom-instruction">ã‚«ã‚¹ã‚¿ãƒ æŒ‡ç¤ºï¼ˆä»»æ„ï¼‰</label>
                    <textarea id="custom-instruction" rows="3" placeholder="ä¾‹ï¼šå„ã‚¹ãƒ†ãƒƒãƒ—ã«ã¯å®‰å…¨æ³¨æ„ã‚’1ã¤ä»¥ä¸Šå«ã‚ã‚‹ã€ç°¡æ½”ãªæ–‡ç« ã§ç”Ÿæˆã—ã¦ãã ã•ã„"></textarea>
                </div>
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div style="text-align: center; margin: 30px 0;">
                <a href="/manual/list" class="btn btn-secondary"><span class="material-icons">arrow_back</span>ä¸€è¦§ã«æˆ»ã‚‹</a>
                <button type="button" class="btn btn-primary" id="create-btn" disabled>
                    <span class="material-icons">auto_fix_high</span>
                    ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ä½œæˆé–‹å§‹
                </button>
                <p style="margin-top: 15px; color: #666; font-size: 13px;">
                    â€» å‡¦ç†ã«ã¯æ•°åˆ†ã‹ã‹ã‚Šã¾ã™ã€‚å®Œäº†å¾Œã€ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ä¸€è¦§ãƒšãƒ¼ã‚¸ã§çµæœã‚’ç¢ºèªã§ãã¾ã™ã€‚
                </p>
            </div>
        </form>
    </div>

    <script>
        let uploadedFile = null;

        document.addEventListener('DOMContentLoaded', function () {
            setupFileUpload();
            setupFormValidation();
            setupOutputDetailHandler();
        });

        function setupFileUpload() {
            const input = document.getElementById('video-file');
            const area = document.getElementById('upload-area');
            const video = document.getElementById('video');
            const preview = document.getElementById('video-preview');
            const info = document.getElementById('video-info');

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
            input.addEventListener('change', function (e) {
                if (e.target.files.length > 0) {
                    handleVideoFile(e.target.files[0], area, video, preview, info);
                }
            });

            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            area.addEventListener('dragover', function (e) {
                e.preventDefault();
                area.classList.add('dragover');
            });

            area.addEventListener('dragleave', function (e) {
                e.preventDefault();
                area.classList.remove('dragover');
            });

            area.addEventListener('drop', function (e) {
                e.preventDefault();
                area.classList.remove('dragover');

                if (e.dataTransfer.files.length > 0) {
                    handleVideoFile(e.dataTransfer.files[0], area, video, preview, info);
                }
            });
        }

        async function handleVideoFile(file, area, video, preview, info) {
            if (!file.type.startsWith('video/')) {
                showMessage('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            if (file.size > 2 * 1024 * 1024 * 1024) {
                showMessage('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚2GBä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¡ãƒ¢ãƒªã«ä¿å­˜
            uploadedFile = file;

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            const url = URL.createObjectURL(file);
            video.src = url;
            preview.style.display = 'block';
            area.classList.add('has-file');

            // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±è¡¨ç¤º
            info.innerHTML = `
                <div><strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> ${file.name}</div>
                <div><strong>ã‚µã‚¤ã‚º:</strong> ${formatFileSize(file.size)}</div>
                <div><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> <span style="color: #28a745;"><span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 5px;">check_circle</span>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†</span></div>
            `;

            // ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
            updateFormValidation();
        }

        function setupFormValidation() {
            const titleInput = document.getElementById('manual-title');
            
            titleInput.addEventListener('input', updateFormValidation);
            updateFormValidation();
        }

        function updateFormValidation() {
            const createBtn = document.getElementById('create-btn');
            const title = document.getElementById('manual-title').value.trim();
            const hasFile = uploadedFile !== null;

            createBtn.disabled = !(hasFile && title);
        }

        function setupOutputDetailHandler() {
            const outputDetailSelect = document.getElementById('length');
            const customInstructionTextarea = document.getElementById('custom-instruction');
            let lastOutputDetail = '';

            const detailTemplates = {
                'concise': 'å„é …ç›®ã¯1-2è¡Œã§ç°¡æ½”ã«è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚è¦ç‚¹ã®ã¿ã‚’å«ã‚ã€å†—é•·ãªèª¬æ˜ã¯é¿ã‘ã¦ãã ã•ã„ã€‚',
                'standard': 'å„é …ç›®ã¯2-4è¡Œç¨‹åº¦ã§é©åº¦ã«è©³ã—ãè¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚å®Ÿç”¨çš„ãªæƒ…å ±ã‚’å«ã‚ã¦ãã ã•ã„ã€‚',
                'detailed': 'å„é …ç›®ã¯4-6è¡Œç¨‹åº¦ã§è©³ç´°ã«è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚èƒŒæ™¯æƒ…å ±ã‚„æ³¨æ„ç‚¹ã‚‚å«ã‚ã¦ãã ã•ã„ã€‚'
            };

            outputDetailSelect.addEventListener('change', function() {
                const selectedDetail = this.value;
                let currentInstruction = customInstructionTextarea.value;

                // å‰å›ã®å‡ºåŠ›è©³ç´°åº¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤
                if (lastOutputDetail && detailTemplates[lastOutputDetail]) {
                    const lastTemplate = detailTemplates[lastOutputDetail];
                    currentInstruction = currentInstruction.replace(lastTemplate, '').trim();
                }

                // æ–°ã—ã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿½åŠ 
                if (selectedDetail && detailTemplates[selectedDetail]) {
                    const newTemplate = detailTemplates[selectedDetail];
                    if (currentInstruction) {
                        currentInstruction = currentInstruction + '\n\n' + newTemplate;
                    } else {
                        currentInstruction = newTemplate;
                    }
                }

                customInstructionTextarea.value = currentInstruction;
                lastOutputDetail = selectedDetail;
            });
        }

        // ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ä½œæˆå‡¦ç†
        document.getElementById('create-btn').addEventListener('click', async function () {
            if (!uploadedFile) {
                showMessage('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const title = document.getElementById('manual-title').value.trim();
            if (!title) {
                showMessage('ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                showProgress('ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç”Ÿæˆé–‹å§‹', 'å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');

                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                const formData = new FormData();
                formData.append('video_file', uploadedFile);
                formData.append('title', title);
                formData.append('description', document.getElementById('manual-description').value);
                // ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé–¢é€£ï¼ˆãƒãƒ‹ãƒ¥ã‚¢ãƒ«èª¬æ˜ã‚’purposeã¨ã—ã¦ã‚‚ä½¿ç”¨ï¼‰
                formData.append('purpose', document.getElementById('manual-description').value || '');
                formData.append('custom_instruction', document.getElementById('custom-instruction').value || '');
                
                // å‡ºåŠ›è©³ç´°åº¦ã®å‡¦ç†ã¯å»ƒæ­¢ï¼ˆã‚«ã‚¹ã‚¿ãƒ æŒ‡ç¤ºã«çµ±åˆæ¸ˆã¿ï¼‰
                formData.append('output_detail', 'titles_with_descriptions');

                const response = await fetch('/api/video-manual/three-stage/async-generate', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ä½œæˆã‚’é–‹å§‹ã—ã¾ã—ãŸï¼', 'success');
                    setTimeout(() => {
                        window.location.href = '/manual/list';
                    }, 2000);
                } else {
                    hideProgress();
                    showMessage('ã‚¨ãƒ©ãƒ¼: ' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'), 'error');
                }
            } catch (error) {
                hideProgress();
                showMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        });

        function showProgress(title, message) {
            document.getElementById('progress-title').textContent = title;
            document.getElementById('progress-message').textContent = message;
            document.getElementById('progress-section').style.display = 'block';

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç„¡åŠ¹åŒ–
            document.getElementById('manual-form').style.opacity = '0.5';
            document.getElementById('create-btn').disabled = true;
        }

        function hideProgress() {
            document.getElementById('progress-section').style.display = 'none';
            document.getElementById('manual-form').style.opacity = '1';
            updateFormValidation();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                max-width: 300px;
            `;

            // ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
            const iconMap = {
                'success': 'check_circle',
                'error': 'error',
                'info': 'info'
            };

            messageDiv.innerHTML = `<span class="material-icons">${iconMap[type] || 'info'}</span>${message}`;

            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, type === 'error' ? 7000 : 4000);
        }
    </script>
{% endblock %}